import{a as N,H as A,I}from"./entry-1765888035645-index.js";import{C as Z}from"./chunk-1765888035845-index.js";var b;(function(e){e.STRING="string",e.NUMBER="number",e.INTEGER="integer",e.BOOLEAN="boolean",e.ARRAY="array",e.OBJECT="object"})(b||(b={}));var L;(function(e){e.LANGUAGE_UNSPECIFIED="language_unspecified",e.PYTHON="python"})(L||(L={}));var M;(function(e){e.OUTCOME_UNSPECIFIED="outcome_unspecified",e.OUTCOME_OK="outcome_ok",e.OUTCOME_FAILED="outcome_failed",e.OUTCOME_DEADLINE_EXCEEDED="outcome_deadline_exceeded"})(M||(M={}));const D=["user","model","function","system"];var G;(function(e){e.HARM_CATEGORY_UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",e.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",e.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",e.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",e.HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT",e.HARM_CATEGORY_CIVIC_INTEGRITY="HARM_CATEGORY_CIVIC_INTEGRITY"})(G||(G={}));var H;(function(e){e.HARM_BLOCK_THRESHOLD_UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",e.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",e.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",e.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",e.BLOCK_NONE="BLOCK_NONE"})(H||(H={}));var U;(function(e){e.HARM_PROBABILITY_UNSPECIFIED="HARM_PROBABILITY_UNSPECIFIED",e.NEGLIGIBLE="NEGLIGIBLE",e.LOW="LOW",e.MEDIUM="MEDIUM",e.HIGH="HIGH"})(U||(U={}));var F;(function(e){e.BLOCKED_REASON_UNSPECIFIED="BLOCKED_REASON_UNSPECIFIED",e.SAFETY="SAFETY",e.OTHER="OTHER"})(F||(F={}));var R;(function(e){e.FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",e.STOP="STOP",e.MAX_TOKENS="MAX_TOKENS",e.SAFETY="SAFETY",e.RECITATION="RECITATION",e.LANGUAGE="LANGUAGE",e.BLOCKLIST="BLOCKLIST",e.PROHIBITED_CONTENT="PROHIBITED_CONTENT",e.SPII="SPII",e.MALFORMED_FUNCTION_CALL="MALFORMED_FUNCTION_CALL",e.OTHER="OTHER"})(R||(R={}));var x;(function(e){e.TASK_TYPE_UNSPECIFIED="TASK_TYPE_UNSPECIFIED",e.RETRIEVAL_QUERY="RETRIEVAL_QUERY",e.RETRIEVAL_DOCUMENT="RETRIEVAL_DOCUMENT",e.SEMANTIC_SIMILARITY="SEMANTIC_SIMILARITY",e.CLASSIFICATION="CLASSIFICATION",e.CLUSTERING="CLUSTERING"})(x||(x={}));var k;(function(e){e.MODE_UNSPECIFIED="MODE_UNSPECIFIED",e.AUTO="AUTO",e.ANY="ANY",e.NONE="NONE"})(k||(k={}));var j;(function(e){e.MODE_UNSPECIFIED="MODE_UNSPECIFIED",e.MODE_DYNAMIC="MODE_DYNAMIC"})(j||(j={}));class h extends Error{constructor(t){super(`[GoogleGenerativeAI Error]: ${t}`)}}class S extends h{constructor(t,n){super(t),this.response=n}}class z extends h{constructor(t,n,s,o){super(t),this.status=n,this.statusText=s,this.errorDetails=o}}class m extends h{}class J extends h{}const ee="https://generativelanguage.googleapis.com",te="v1beta",ne="0.24.1",se="genai-js";var y;(function(e){e.GENERATE_CONTENT="generateContent",e.STREAM_GENERATE_CONTENT="streamGenerateContent",e.COUNT_TOKENS="countTokens",e.EMBED_CONTENT="embedContent",e.BATCH_EMBED_CONTENTS="batchEmbedContents"})(y||(y={}));class oe{constructor(t,n,s,o,a){this.model=t,this.task=n,this.apiKey=s,this.stream=o,this.requestOptions=a}toString(){var t,n;const s=((t=this.requestOptions)===null||t===void 0?void 0:t.apiVersion)||te;let a=`${((n=this.requestOptions)===null||n===void 0?void 0:n.baseUrl)||ee}/${s}/${this.model}:${this.task}`;return this.stream&&(a+="?alt=sse"),a}}function ae(e){const t=[];return e?.apiClient&&t.push(e.apiClient),t.push(`${se}/${ne}`),t.join(" ")}async function ie(e){var t;const n=new Headers;n.append("Content-Type","application/json"),n.append("x-goog-api-client",ae(e.requestOptions)),n.append("x-goog-api-key",e.apiKey);let s=(t=e.requestOptions)===null||t===void 0?void 0:t.customHeaders;if(s){if(!(s instanceof Headers))try{s=new Headers(s)}catch(o){throw new m(`unable to convert customHeaders value ${JSON.stringify(s)} to Headers: ${o.message}`)}for(const[o,a]of s.entries()){if(o==="x-goog-api-key")throw new m(`Cannot set reserved header name ${o}`);if(o==="x-goog-api-client")throw new m(`Header name ${o} can only be set using the apiClient field`);n.append(o,a)}}return n}async function re(e,t,n,s,o,a){const i=new oe(e,t,n,s,a);return{url:i.toString(),fetchOptions:Object.assign(Object.assign({},ue(a)),{method:"POST",headers:await ie(i),body:o})}}async function w(e,t,n,s,o,a={},i=fetch){const{url:r,fetchOptions:c}=await re(e,t,n,s,o,a);return ce(r,c,i)}async function ce(e,t,n=fetch){let s;try{s=await n(e,t)}catch(o){le(o,e)}return s.ok||await de(s,e),s}function le(e,t){let n=e;throw n.name==="AbortError"?(n=new J(`Request aborted when fetching ${t.toString()}: ${e.message}`),n.stack=e.stack):e instanceof z||e instanceof m||(n=new h(`Error fetching from ${t.toString()}: ${e.message}`),n.stack=e.stack),n}async function de(e,t){let n="",s;try{const o=await e.json();n=o.error.message,o.error.details&&(n+=` ${JSON.stringify(o.error.details)}`,s=o.error.details)}catch{}throw new z(`Error fetching from ${t.toString()}: [${e.status} ${e.statusText}] ${n}`,e.status,e.statusText,s)}function ue(e){const t={};if(e?.signal!==void 0||e?.timeout>=0){const n=new AbortController;e?.timeout>=0&&setTimeout(()=>n.abort(),e.timeout),e?.signal&&e.signal.addEventListener("abort",()=>{n.abort()}),t.signal=n.signal}return t}function T(e){return e.text=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning text from the first candidate only. Access response.candidates directly to use the other candidates.`),_(e.candidates[0]))throw new S(`${p(e)}`,e);return fe(e)}else if(e.promptFeedback)throw new S(`Text not available. ${p(e)}`,e);return""},e.functionCall=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),_(e.candidates[0]))throw new S(`${p(e)}`,e);return console.warn("response.functionCall() is deprecated. Use response.functionCalls() instead."),P(e)[0]}else if(e.promptFeedback)throw new S(`Function call not available. ${p(e)}`,e)},e.functionCalls=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),_(e.candidates[0]))throw new S(`${p(e)}`,e);return P(e)}else if(e.promptFeedback)throw new S(`Function call not available. ${p(e)}`,e)},e}function fe(e){var t,n,s,o;const a=[];if(!((n=(t=e.candidates)===null||t===void 0?void 0:t[0].content)===null||n===void 0)&&n.parts)for(const i of(o=(s=e.candidates)===null||s===void 0?void 0:s[0].content)===null||o===void 0?void 0:o.parts)i.text&&a.push(i.text),i.executableCode&&a.push("\n```"+i.executableCode.language+`
`+i.executableCode.code+"\n```\n"),i.codeExecutionResult&&a.push("\n```\n"+i.codeExecutionResult.output+"\n```\n");return a.length>0?a.join(""):""}function P(e){var t,n,s,o;const a=[];if(!((n=(t=e.candidates)===null||t===void 0?void 0:t[0].content)===null||n===void 0)&&n.parts)for(const i of(o=(s=e.candidates)===null||s===void 0?void 0:s[0].content)===null||o===void 0?void 0:o.parts)i.functionCall&&a.push(i.functionCall);if(a.length>0)return a}const he=[R.RECITATION,R.SAFETY,R.LANGUAGE];function _(e){return!!e.finishReason&&he.includes(e.finishReason)}function p(e){var t,n,s;let o="";if((!e.candidates||e.candidates.length===0)&&e.promptFeedback)o+="Response was blocked",!((t=e.promptFeedback)===null||t===void 0)&&t.blockReason&&(o+=` due to ${e.promptFeedback.blockReason}`),!((n=e.promptFeedback)===null||n===void 0)&&n.blockReasonMessage&&(o+=`: ${e.promptFeedback.blockReasonMessage}`);else if(!((s=e.candidates)===null||s===void 0)&&s[0]){const a=e.candidates[0];_(a)&&(o+=`Candidate was blocked due to ${a.finishReason}`,a.finishMessage&&(o+=`: ${a.finishMessage}`))}return o}function v(e){return this instanceof v?(this.v=e,this):new v(e)}function ge(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s=n.apply(e,t||[]),o,a=[];return o={},i("next"),i("throw"),i("return"),o[Symbol.asyncIterator]=function(){return this},o;function i(d){s[d]&&(o[d]=function(u){return new Promise(function(g,C){a.push([d,u,g,C])>1||r(d,u)})})}function r(d,u){try{c(s[d](u))}catch(g){E(a[0][3],g)}}function c(d){d.value instanceof v?Promise.resolve(d.value.v).then(f,l):E(a[0][2],d)}function f(d){r("next",d)}function l(d){r("throw",d)}function E(d,u){d(u),a.shift(),a.length&&r(a[0][0],a[0][1])}}const Y=/^data\: (.*)(?:\n\n|\r\r|\r\n\r\n)/;function Ee(e){const t=e.body.pipeThrough(new TextDecoderStream("utf8",{fatal:!0})),n=ye(t),[s,o]=n.tee();return{stream:me(s),response:pe(o)}}async function pe(e){const t=[],n=e.getReader();for(;;){const{done:s,value:o}=await n.read();if(s)return T(Ce(t));t.push(o)}}function me(e){return ge(this,arguments,function*(){const n=e.getReader();for(;;){const{value:s,done:o}=yield v(n.read());if(o)break;yield yield v(T(s))}})}function ye(e){const t=e.getReader();return new ReadableStream({start(s){let o="";return a();function a(){return t.read().then(({value:i,done:r})=>{if(r){if(o.trim()){s.error(new h("Failed to parse stream"));return}s.close();return}o+=i;let c=o.match(Y),f;for(;c;){try{f=JSON.parse(c[1])}catch{s.error(new h(`Error parsing JSON response: "${c[1]}"`));return}s.enqueue(f),o=o.substring(c[0].length),c=o.match(Y)}return a()}).catch(i=>{let r=i;throw r.stack=i.stack,r.name==="AbortError"?r=new J("Request aborted when reading from the stream"):r=new h("Error reading from the stream"),r})}}})}function Ce(e){const t=e[e.length-1],n={promptFeedback:t?.promptFeedback};for(const s of e){if(s.candidates){let o=0;for(const a of s.candidates)if(n.candidates||(n.candidates=[]),n.candidates[o]||(n.candidates[o]={index:o}),n.candidates[o].citationMetadata=a.citationMetadata,n.candidates[o].groundingMetadata=a.groundingMetadata,n.candidates[o].finishReason=a.finishReason,n.candidates[o].finishMessage=a.finishMessage,n.candidates[o].safetyRatings=a.safetyRatings,a.content&&a.content.parts){n.candidates[o].content||(n.candidates[o].content={role:a.content.role||"user",parts:[]});const i={};for(const r of a.content.parts)r.text&&(i.text=r.text),r.functionCall&&(i.functionCall=r.functionCall),r.executableCode&&(i.executableCode=r.executableCode),r.codeExecutionResult&&(i.codeExecutionResult=r.codeExecutionResult),Object.keys(i).length===0&&(i.text=""),n.candidates[o].content.parts.push(i)}o++}s.usageMetadata&&(n.usageMetadata=s.usageMetadata)}return n}async function W(e,t,n,s){const o=await w(t,y.STREAM_GENERATE_CONTENT,e,!0,JSON.stringify(n),s);return Ee(o)}async function X(e,t,n,s){const a=await(await w(t,y.GENERATE_CONTENT,e,!1,JSON.stringify(n),s)).json();return{response:T(a)}}function Q(e){if(e!=null){if(typeof e=="string")return{role:"system",parts:[{text:e}]};if(e.text)return{role:"system",parts:[e]};if(e.parts)return e.role?e:{role:"system",parts:e.parts}}}function O(e){let t=[];if(typeof e=="string")t=[{text:e}];else for(const n of e)typeof n=="string"?t.push({text:n}):t.push(n);return Ae(t)}function Ae(e){const t={role:"user",parts:[]},n={role:"function",parts:[]};let s=!1,o=!1;for(const a of e)"functionResponse"in a?(n.parts.push(a),o=!0):(t.parts.push(a),s=!0);if(s&&o)throw new h("Within a single message, FunctionResponse cannot be mixed with other type of part in the request for sending chat message.");if(!s&&!o)throw new h("No content is provided for sending chat message.");return s?t:n}function Ie(e,t){var n;let s={model:t?.model,generationConfig:t?.generationConfig,safetySettings:t?.safetySettings,tools:t?.tools,toolConfig:t?.toolConfig,systemInstruction:t?.systemInstruction,cachedContent:(n=t?.cachedContent)===null||n===void 0?void 0:n.name,contents:[]};const o=e.generateContentRequest!=null;if(e.contents){if(o)throw new m("CountTokensRequest must have one of contents or generateContentRequest, not both.");s.contents=e.contents}else if(o)s=Object.assign(Object.assign({},s),e.generateContentRequest);else{const a=O(e);s.contents=[a]}return{generateContentRequest:s}}function $(e){let t;return e.contents?t=e:t={contents:[O(e)]},e.systemInstruction&&(t.systemInstruction=Q(e.systemInstruction)),t}function Se(e){return typeof e=="string"||Array.isArray(e)?{content:O(e)}:e}const K=["text","inlineData","functionCall","functionResponse","executableCode","codeExecutionResult"],Re={user:["text","inlineData"],function:["functionResponse"],model:["text","functionCall","executableCode","codeExecutionResult"],system:["text"]};function ve(e){let t=!1;for(const n of e){const{role:s,parts:o}=n;if(!t&&s!=="user")throw new h(`First content should be with role 'user', got ${s}`);if(!D.includes(s))throw new h(`Each item should include role field. Got ${s} but valid roles are: ${JSON.stringify(D)}`);if(!Array.isArray(o))throw new h("Content should have 'parts' property with an array of Parts");if(o.length===0)throw new h("Each Content should have at least one part");const a={text:0,inlineData:0,functionCall:0,functionResponse:0,fileData:0,executableCode:0,codeExecutionResult:0};for(const r of o)for(const c of K)c in r&&(a[c]+=1);const i=Re[s];for(const r of K)if(!i.includes(r)&&a[r]>0)throw new h(`Content with role '${s}' can't contain '${r}' part`);t=!0}}function B(e){var t;if(e.candidates===void 0||e.candidates.length===0)return!1;const n=(t=e.candidates[0])===null||t===void 0?void 0:t.content;if(n===void 0||n.parts===void 0||n.parts.length===0)return!1;for(const s of n.parts)if(s===void 0||Object.keys(s).length===0||s.text!==void 0&&s.text==="")return!1;return!0}const V="SILENT_ERROR";class Oe{constructor(t,n,s,o={}){this.model=n,this.params=s,this._requestOptions=o,this._history=[],this._sendPromise=Promise.resolve(),this._apiKey=t,s?.history&&(ve(s.history),this._history=s.history)}async getHistory(){return await this._sendPromise,this._history}async sendMessage(t,n={}){var s,o,a,i,r,c;await this._sendPromise;const f=O(t),l={safetySettings:(s=this.params)===null||s===void 0?void 0:s.safetySettings,generationConfig:(o=this.params)===null||o===void 0?void 0:o.generationConfig,tools:(a=this.params)===null||a===void 0?void 0:a.tools,toolConfig:(i=this.params)===null||i===void 0?void 0:i.toolConfig,systemInstruction:(r=this.params)===null||r===void 0?void 0:r.systemInstruction,cachedContent:(c=this.params)===null||c===void 0?void 0:c.cachedContent,contents:[...this._history,f]},E=Object.assign(Object.assign({},this._requestOptions),n);let d;return this._sendPromise=this._sendPromise.then(()=>X(this._apiKey,this.model,l,E)).then(u=>{var g;if(B(u.response)){this._history.push(f);const C=Object.assign({parts:[],role:"model"},(g=u.response.candidates)===null||g===void 0?void 0:g[0].content);this._history.push(C)}else{const C=p(u.response);C&&console.warn(`sendMessage() was unsuccessful. ${C}. Inspect response object for details.`)}d=u}).catch(u=>{throw this._sendPromise=Promise.resolve(),u}),await this._sendPromise,d}async sendMessageStream(t,n={}){var s,o,a,i,r,c;await this._sendPromise;const f=O(t),l={safetySettings:(s=this.params)===null||s===void 0?void 0:s.safetySettings,generationConfig:(o=this.params)===null||o===void 0?void 0:o.generationConfig,tools:(a=this.params)===null||a===void 0?void 0:a.tools,toolConfig:(i=this.params)===null||i===void 0?void 0:i.toolConfig,systemInstruction:(r=this.params)===null||r===void 0?void 0:r.systemInstruction,cachedContent:(c=this.params)===null||c===void 0?void 0:c.cachedContent,contents:[...this._history,f]},E=Object.assign(Object.assign({},this._requestOptions),n),d=W(this._apiKey,this.model,l,E);return this._sendPromise=this._sendPromise.then(()=>d).catch(u=>{throw new Error(V)}).then(u=>u.response).then(u=>{if(B(u)){this._history.push(f);const g=Object.assign({},u.candidates[0].content);g.role||(g.role="model"),this._history.push(g)}else{const g=p(u);g&&console.warn(`sendMessageStream() was unsuccessful. ${g}. Inspect response object for details.`)}}).catch(u=>{u.message!==V&&console.error(u)}),d}}async function we(e,t,n,s){return(await w(t,y.COUNT_TOKENS,e,!1,JSON.stringify(n),s)).json()}async function _e(e,t,n,s){return(await w(t,y.EMBED_CONTENT,e,!1,JSON.stringify(n),s)).json()}async function Ne(e,t,n,s){const o=n.requests.map(i=>Object.assign(Object.assign({},i),{model:t}));return(await w(t,y.BATCH_EMBED_CONTENTS,e,!1,JSON.stringify({requests:o}),s)).json()}class q{constructor(t,n,s={}){this.apiKey=t,this._requestOptions=s,n.model.includes("/")?this.model=n.model:this.model=`models/${n.model}`,this.generationConfig=n.generationConfig||{},this.safetySettings=n.safetySettings||[],this.tools=n.tools,this.toolConfig=n.toolConfig,this.systemInstruction=Q(n.systemInstruction),this.cachedContent=n.cachedContent}async generateContent(t,n={}){var s;const o=$(t),a=Object.assign(Object.assign({},this._requestOptions),n);return X(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:(s=this.cachedContent)===null||s===void 0?void 0:s.name},o),a)}async generateContentStream(t,n={}){var s;const o=$(t),a=Object.assign(Object.assign({},this._requestOptions),n);return W(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:(s=this.cachedContent)===null||s===void 0?void 0:s.name},o),a)}startChat(t){var n;return new Oe(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:(n=this.cachedContent)===null||n===void 0?void 0:n.name},t),this._requestOptions)}async countTokens(t,n={}){const s=Ie(t,{model:this.model,generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:this.cachedContent}),o=Object.assign(Object.assign({},this._requestOptions),n);return we(this.apiKey,this.model,s,o)}async embedContent(t,n={}){const s=Se(t),o=Object.assign(Object.assign({},this._requestOptions),n);return _e(this.apiKey,this.model,s,o)}async batchEmbedContents(t,n={}){const s=Object.assign(Object.assign({},this._requestOptions),n);return Ne(this.apiKey,this.model,t,s)}}class Te{constructor(t){this.apiKey=t}getGenerativeModel(t,n){if(!t.model)throw new h("Must provide a model name. Example: genai.getGenerativeModel({ model: 'my-model-name' })");return new q(this.apiKey,t,n)}getGenerativeModelFromCachedContent(t,n,s){if(!t.name)throw new m("Cached content must contain a `name` field.");if(!t.model)throw new m("Cached content must contain a `model` field.");const o=["model","systemInstruction"];for(const i of o)if(n?.[i]&&t[i]&&n?.[i]!==t[i]){if(i==="model"){const r=n.model.startsWith("models/")?n.model.replace("models/",""):n.model,c=t.model.startsWith("models/")?t.model.replace("models/",""):t.model;if(r===c)continue}throw new m(`Different value for "${i}" specified in modelParams (${n[i]}) and cachedContent (${t[i]})`)}const a=Object.assign(Object.assign({},n),{model:t.model,tools:t.tools,toolConfig:t.toolConfig,systemInstruction:t.systemInstruction,cachedContent:t});return new q(this.apiKey,a,s)}}class be{constructor(){this.analyzing=!1}async captureFoodPhoto(){try{const t=await Z.getPhoto({quality:50,allowEditing:!1,resultType:"base64",source:"CAMERA",width:1024,height:1024});return{success:!0,imageData:t.base64String,format:t.format}}catch(t){return{success:!1,error:t.message}}}async analyzeFoodImage(t){if(this.analyzing)return{success:!1,error:"Analysis already in progress"};try{this.analyzing=!0;const n=N.getUserAllergenProfile(),s=this.buildAnalysisPrompt(n);let o;try{const i=await fetch("https://helio-wellness-app-production.up.railway.app/api/vision",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({prompt:s,imageData:t}),mode:"cors"});if(!i.ok)throw new Error(`Server returned ${i.status}`);o=(await i.json()).response}catch{const r="AIzaSyDLPSfwTwMiQ7bDXiItiYHSlegpNtlr-jg",c=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${r}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:s},{inline_data:{mime_type:"image/jpeg",data:t}}]}]})});if(!c.ok){const l=await c.json().catch(()=>({}));throw new Error(l.error?.message||`API Error: ${c.status}`)}o=(await c.json()).candidates?.[0]?.content?.parts?.[0]?.text}if(!o)throw new Error("Empty response from AI");const a=this.parseAIResponse(o,n);return await this.triggerSafetyHaptic(a.safetyLevel),this.analyzing=!1,{success:!0,analysis:a}}catch(n){return this.analyzing=!1,{success:!1,error:n.message}}}buildAnalysisPrompt(t){t||(t={allergens:[],intolerances:[],dietaryPreferences:[]});const{allergens:n=[],intolerances:s=[],dietaryPreferences:o=[]}=t;let a=`Analyze this food image in detail. Provide:

1. FOOD NAME: What is this dish called?
2. MAIN INGREDIENTS: List all visible ingredients
3. LIKELY HIDDEN INGREDIENTS: Common ingredients not visible (sauces, seasonings, etc.)
4. ALLERGEN ANALYSIS: Check for these allergens:`;return n&&n.length>0&&(a+=`
   USER'S ALLERGENS: ${n.join(", ")}`),s&&s.length>0&&(a+=`
   USER'S INTOLERANCES: ${s.join(", ")}`),o&&o.length>0&&(a+=`
   USER'S DIET: ${o.join(", ")}`),a+=`

5. SAFETY ASSESSMENT: Rate as SAFE, CAUTION, or DANGER
6. DETECTED ALLERGENS: List any allergens found with severity
7. ALTERNATIVES: Suggest how to make this safe (remove/substitute ingredients)
8. CONFIDENCE: How confident are you in this analysis? (0-100%)

Format your response as JSON:
{
  "foodName": "name",
  "ingredients": ["ingredient1", "ingredient2"],
  "hiddenIngredients": ["hidden1", "hidden2"],
  "detectedAllergens": [{"name": "allergen", "confidence": "high/medium/low", "location": "where found"}],
  "safetyLevel": "safe|caution|danger",
  "safetyExplanation": "why safe or unsafe",
  "alternatives": ["suggestion1", "suggestion2"],
  "confidence": 85
}`,a}parseAIResponse(t,n){try{const s=t.match(/\{[\s\S]*\}/);if(!s)throw new Error("No JSON found in response");const o=JSON.parse(s[0]),a=this.determineSafety(o,n);return{foodName:o.foodName||"Unknown Food",ingredients:o.ingredients||[],hiddenIngredients:o.hiddenIngredients||[],detectedAllergens:o.detectedAllergens||[],safetyLevel:a.level,safetyColor:a.color,safetyIcon:a.icon,safetyMessage:a.message,alternatives:o.alternatives||[],confidence:o.confidence||50,rawAnalysis:t}}catch{return{foodName:"Analysis Complete",ingredients:[],detectedAllergens:[],safetyLevel:"unknown",safetyColor:"#FFA500",safetyIcon:"â“",safetyMessage:"Unable to parse full analysis. Please review manually.",alternatives:[],confidence:0,rawAnalysis:t}}}determineSafety(t,n){n||(n={allergens:[],allergenSeverity:{}});const{allergens:s=[],allergenSeverity:o={}}=n,a=t.detectedAllergens||[],i=a.find(c=>{const f=c.name.toLowerCase();return s.some(l=>{const E=f.includes(l.toLowerCase()),d=o[l];return E&&d==="severe"})});if(i)return{level:"danger",color:"#FF4444",icon:"ðŸš«",message:`DANGER: Contains ${i.name.toUpperCase()} - Your severe allergen!`};const r=a.find(c=>{const f=c.name.toLowerCase();return s.some(l=>f.includes(l.toLowerCase()))});return r?{level:"caution",color:"#FFA500",icon:"âš ï¸",message:`CAUTION: Contains ${r.name} - Your allergen`}:{level:"safe",color:"#44FF44",icon:"âœ…",message:"SAFE: No detected allergens for your profile"}}async triggerSafetyHaptic(t){try{switch(t){case"danger":await A.impact({style:I.Heavy}),await new Promise(n=>setTimeout(n,100)),await A.impact({style:I.Heavy}),await new Promise(n=>setTimeout(n,100)),await A.impact({style:I.Heavy});break;case"caution":await A.impact({style:I.Medium}),await new Promise(n=>setTimeout(n,150)),await A.impact({style:I.Medium});break;case"safe":await A.impact({style:I.Light});break}}catch{}}async analyzeHalalStatus(t){try{const n=`ðŸ•Œ HALAL STATUS ANALYSIS ONLY - DO NOT PERFORM FOOD SAFETY ANALYSIS

You are a Halal certification expert analyzing this product for Islamic dietary compliance.

âš ï¸ CRITICAL: You MUST return ONLY Halal status analysis. DO NOT analyze allergens, food safety, or nutritional content.

**YOUR TASK:**
Analyze this food product label ONLY for Islamic dietary compliance (Halal/Haram status).

**HARAM INGREDIENTS** (strictly forbidden):

1. **PORK/SWINE PRODUCTS:**
   - Pork, bacon, ham, salami (pork), pepperoni (pork), chorizo (pork)
   - Lard, pork fat, pancetta, prosciutto, sausage (pork), chicharrones
   - Pork gelatin, pork collagen, pork enzymes
   - Bacon bits, bacon flavoring, ham flavoring

2. **ALCOHOL & DERIVATIVES:**
   - Wine, beer, vodka, rum, whiskey, gin, tequila, liqueur
   - Cooking wine, rice wine, mirin, sake, sherry
   - Vanilla extract (alcohol-based), rum extract, brandy extract
   - Beer batter, wine vinegar (with alcohol), alcoholic beverages
   - Ethanol, ethyl alcohol (as ingredient, not trace from fermentation)

3. **BLOOD PRODUCTS:**
   - Blood sausage, black pudding, blood cake, morcilla, boudin noir
   - Any product containing animal blood

4. **MEAT FROM FORBIDDEN ANIMALS:**
   - Carnivores: dog, cat, lion, tiger, wolf, bear, hyena
   - Donkey, mule, horse (according to some schools)
   - Birds of prey: eagle, hawk, falcon, vulture, owl
   - Reptiles: snake, crocodile, alligator, turtle, lizard, frog
   - Amphibians: frog, toad, salamander

5. **INSECTS** (except locust/grasshopper):
   - Crickets, mealworms, ants, bees, wasps, beetles
   - Cochineal/Carmine (E120 - crushed beetles for red coloring)
   - Any insect-based protein or flavoring

6. **IMPROPER SLAUGHTER:**
   - Meat not slaughtered with Islamic method (no Bismillah)
   - Carrion, roadkill, dead animals, strangled animals
   - Stunned animals (not properly slaughtered after)

**DOUBTFUL/MUSHBOOH** (needs source verification):

1. **ANIMAL-DERIVED (unknown source):**
   - Gelatin (beef or pork? Check source)
   - Rennet (animal or microbial?)
   - Enzymes (animal, plant, or microbial?)
   - Lipase, pepsin, trypsin (animal source?)
   - Whey (if cheese made with animal rennet)
   - L-cysteine (may be from human/pig hair or synthetic)
   - Tallow, suet, animal fat, animal shortening

2. **E-CODES** (potentially animal-derived):
   - E120 (Carmine/Cochineal - beetle extract) âŒ HARAM
   - E441 (Gelatin - pork or beef?) âš ï¸ VERIFY
   - E471, E472 (Mono/Diglycerides - animal or plant fat?) âš ï¸ VERIFY
   - E322 (Lecithin - soy or egg?) âš ï¸ VERIFY
   - E542 (Bone phosphate - animal bones) âš ï¸ VERIFY
   - E631, E627 (Disodium inosinate/guanylate - pork or synthetic?) âš ï¸ VERIFY
   - E904 (Shellac - insect secretion) âŒ HARAM (some schools)
   - E1105 (Lysozyme - from egg, usually acceptable)

3. **AMBIGUOUS ADDITIVES:**
   - Natural flavors (may contain alcohol or animal derivatives)
   - Artificial flavors (source unclear)
   - Emulsifiers (animal or plant source?)
   - Stabilizers (animal or plant?)
   - Glycerin/Glycerol (animal fat or vegetable?)
   - Stearic acid (animal or plant?)

**E-CODES TO FLAG AS HARAM:**
E120 (insect-based), E441 (gelatin), E904 (shellac from insects)

**E-CODES TO FLAG AS DOUBTFUL:**
E471, E472, E542, E322, E631, E627 (need source verification)

**HALAL CERTIFICATIONS:**
Look for Halal logos: JAKIM, MUI, HFA, IFANCA, Islamic symbols

**CROSS-CONTAMINATION:**
"May contain" warnings, shared facilities

âš ï¸ YOU MUST RETURN THIS EXACT JSON STRUCTURE:
{
  "halalStatus": "halal" | "haram" | "doubtful" | "uncertain",
  "confidence": 85,
  "haramIngredients": ["Pork - Pig meat is strictly forbidden in Islam"],
  "doubtfulIngredients": ["Gelatin - Source not specified"],
  "eCodes": ["E441 - Gelatin from animal source"],
  "certifications": ["No Halal certification found"],
  "crossContamination": "May contain traces of alcohol",
  "recommendation": "NOT PERMISSIBLE for Muslim consumption",
  "details": "Product contains haram ingredients"
}

âš ï¸ DO NOT return foodName, safetyLevel, or detectedAllergens. ONLY return halalStatus data.`,s="AIzaSyDLPSfwTwMiQ7bDXiItiYHSlegpNtlr-jg",a=new Te(s).getGenerativeModel({model:"gemini-2.0-flash-exp"}),i={inlineData:{data:t.split(",")[1]||t,mimeType:"image/jpeg"}},f=(await a.generateContent([n,i])).response.text().replace(/```json\n?|```\n?/g,"").trim(),l=JSON.parse(f);if(!l.halalStatus)throw console.error("âŒ AI response missing halalStatus field!"),console.error("Response structure:",Object.keys(l)),l.foodName||l.safetyLevel||l.detectedAllergens?new Error("Error: AI returned food analysis instead of Halal status. This is a pork product and should show HARAM. Please try scanning again."):new Error("Could not determine Halal status. Please ensure the product label is clearly visible and try again.");return{success:!0,analysis:{halalStatus:l.halalStatus,confidence:l.confidence||85,haramIngredients:l.haramIngredients||[],doubtfulIngredients:l.doubtfulIngredients||[],eCodes:l.eCodes||[],certifications:l.certifications||[],crossContamination:l.crossContamination||"Unknown",recommendation:l.recommendation||"Consult with a Halal authority for confirmation",details:l.details||"Analysis completed"}}}catch(n){return console.error("Halal analysis error:",n),{success:!1,error:n.message||"Failed to analyze Halal status"}}}async analyzeIngredientLabel(t){try{const n=N.getUserAllergenProfile(),s=`Read and analyze this ingredient label. Extract ALL ingredients and check against user's allergen profile.

USER'S ALLERGENS: ${n.allergens?.join(", ")||"None"}
USER'S INTOLERANCES: ${n.intolerances?.join(", ")||"None"}

Provide:
1. ALL INGREDIENTS: Complete list extracted from label
2. ALLERGEN WARNINGS: Any "contains" or "may contain" statements
3. DETECTED RISKS: Which of user's allergens are present
4. HIDDEN ALLERGENS: Alternative names found (e.g., "whey" = dairy, "albumin" = egg)
5. SAFETY VERDICT: safe/caution/danger

Return as JSON with same format as food analysis.`;let o;try{const i=await fetch("https://helio-wellness-app-production.up.railway.app/api/vision",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({prompt:s,imageData:t}),mode:"cors"});if(!i.ok)throw new Error(`Server returned ${i.status}`);o=(await i.json()).response}catch{const r="AIzaSyDLPSfwTwMiQ7bDXiItiYHSlegpNtlr-jg",c=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${r}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:s},{inline_data:{mime_type:"image/jpeg",data:t}}]}]})});if(!c.ok){const l=await c.json().catch(()=>({}));throw new Error(l.error?.message||`API Error: ${c.status}`)}o=(await c.json()).candidates?.[0]?.content?.parts?.[0]?.text}if(!o)throw new Error("Empty AI response");const a=this.parseAIResponse(o,n);return await this.triggerSafetyHaptic(a.safetyLevel),{success:!0,analysis:a}}catch(n){return{success:!1,error:n.message}}}async checkIngredientText(t){const n=N.getUserAllergenProfile(),{allergens:s,intolerances:o}=n,a=[...s||[],...o||[]],i=[];return a.forEach(c=>{new RegExp(c,"i").test(t)&&i.push(c)}),Object.entries({dairy:["whey","casein","lactose","milk powder","cream","butter","ghee"],egg:["albumin","ovalbumin","lysozyme","meringue","surimi"],soy:["lecithin","tofu","tempeh","miso","shoyu","tamari"],gluten:["wheat","barley","rye","malt","seitan","bulgur"],nuts:["almond","cashew","pistachio","walnut","pecan","hazelnut"]}).forEach(([c,f])=>{s?.includes(c)&&f.forEach(l=>{new RegExp(l,"i").test(t)&&!i.includes(c)&&i.push(`${c} (found as "${l}")`)})}),{safe:i.length===0,detectedAllergens:i,safetyLevel:i.length===0?"safe":"caution"}}}const De=new be;export{De as a};
