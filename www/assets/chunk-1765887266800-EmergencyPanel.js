import{C as P,r as i,j as e}from"./entry-1765887266798-index.js";import{emergencyService as n}from"./chunk-1765887266801-emergencyService.js";class W{constructor(){this.isRunning=!1,this.listeners=[],this.pollInterval=null,this.alertCheckInterval=null,this.currentStatus={}}async start(){try{if(console.log("ğŸš€ Starting native health monitoring service via WebView bridge..."),!P.isNativePlatform()||P.getPlatform()!=="android")throw new Error("Health monitoring only works on Android");if(!window.AndroidHealthMonitoring)throw console.error("âŒ AndroidHealthMonitoring WebView bridge not found"),new Error("AndroidHealthMonitoring bridge not available. App may need restart.");console.log("âœ… AndroidHealthMonitoring bridge found, starting service...");const t=window.AndroidHealthMonitoring.startService(),a=JSON.parse(t);if(console.log("ğŸ“± startService result:",a),a&&a.started)return this.isRunning=!0,console.log("âœ… NATIVE HEALTH MONITORING SERVICE STARTED!"),console.log("   â†’ Persistent notification will appear"),console.log("   â†’ Monitors: Heart Rate, Movement, Location, Falls"),console.log("   â†’ Service runs 24/7 even when app closed"),this.startStatusPolling(),this.startAlertPolling(),!0;throw console.warn("âš ï¸ Service start failed:",a.error||"Unknown error"),new Error(a.error||"Failed to start service")}catch(t){throw console.error("âŒ Failed to start native health monitoring service:",t),t}}async stop(){try{if(window.AndroidHealthMonitoring){const t=window.AndroidHealthMonitoring.stopService(),a=JSON.parse(t);return this.isRunning=!1,this.stopStatusPolling(),this.stopAlertPolling(),console.log("Health monitoring service stopped"),a.stopped}return!1}catch(t){return console.error("Error stopping health monitoring service:",t),!1}}async getStatus(){try{if(window.AndroidHealthMonitoring){const t=window.AndroidHealthMonitoring.getHealthStatus(),a=JSON.parse(t);return this.currentStatus=a,a}return{}}catch(t){return console.error("Error getting health status:",t),{}}}async checkAlerts(){try{if(window.AndroidHealthMonitoring){const t=window.AndroidHealthMonitoring.getAlertStatus(),a=JSON.parse(t);return a.alertTriggered&&(console.warn("âš ï¸ HEALTH ALERT:",a),this.handleAlert(a)),a}return{}}catch(t){return console.error("Error checking alerts:",t),{}}}async dismissAlert(){try{if(window.AndroidHealthMonitoring){const t=window.AndroidHealthMonitoring.dismissAlert(),a=JSON.parse(t);return console.log("Alert dismissed:",a),a.dismissed}return!1}catch(t){return console.error("Error dismissing alert:",t),!1}}handleAlert(t){this.listeners.forEach(a=>{try{a({type:"health",alertType:t.alertType,message:t.alertMessage,timestamp:t.alertTimestamp})}catch(h){console.error("Error in health alert listener:",h)}})}startStatusPolling(){this.pollInterval||(this.pollInterval=setInterval(async()=>{const t=await this.getStatus();t.heartRateAvailable&&t.heartRate!==this.currentStatus.heartRate&&console.log("ğŸ’“ Heart Rate:",t.heartRate,"bpm"),t.stillnessMinutes>0&&t.stillnessMinutes%30===0&&console.log("â±ï¸ Stillness:",t.stillnessMinutes,"minutes")},5e3))}stopStatusPolling(){this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=null)}startAlertPolling(){this.alertCheckInterval||(this.alertCheckInterval=setInterval(async()=>{await this.checkAlerts()},2e3))}stopAlertPolling(){this.alertCheckInterval&&(clearInterval(this.alertCheckInterval),this.alertCheckInterval=null)}addListener(t){this.listeners.push(t)}removeListener(t){this.listeners=this.listeners.filter(a=>a!==t)}isActive(){return this.isRunning}getFormattedStatus(){const t=this.currentStatus;return{heartRate:t.heartRateAvailable?`${Math.round(t.heartRate)} bpm`:"Not available",heartRateAvailable:t.heartRateAvailable||!1,lastMovement:t.lastMovementTime?new Date(t.lastMovementTime).toLocaleTimeString():"Unknown",stillnessMinutes:t.stillnessMinutes||0,stillnessHours:Math.floor((t.stillnessMinutes||0)/60),isMoving:t.isMoving||!1,location:t.locationAvailable?`${t.latitude.toFixed(6)}, ${t.longitude.toFixed(6)}`:"GPS not available",locationAvailable:t.locationAvailable||!1,locationStuckHours:t.locationStuckHours||0,monitoring:this.isRunning,lastUpdate:new Date().toLocaleTimeString()}}}const N=new W;function K({onClose:S}){const[t,a]=i.useState(!1),[h,I]=i.useState(null),[b,D]=i.useState([]),[r,m]=i.useState({name:"",phone:"",relationship:"",primary:!1}),[g,A]=i.useState(!1),[M,E]=i.useState(!1),[o,p]=i.useState(null),[C,k]=i.useState(!1),[j,u]=i.useState(!1),[d,y]=i.useState(!1),[c,R]=i.useState({}),[L,v]=i.useState(null),[Y,f]=i.useState(!1),[T,w]=i.useState(!1),[F,$]=i.useState(!1);i.useEffect(()=>{H()},[]);const H=async()=>{const s=await n.loadEmergencyData(),l=n;a(l.monitoring),I(l.monitoringStatus),D(l.emergencyContacts||[]),p(l.getLocationStatus()),u(l.fallDetectionActive||!1),s?.monitoring&&!l.monitoring&&(await n.startMonitoring(),a(!0),setTimeout(()=>{p(n.getLocationStatus())},1e3)),s?.fallDetection&&!l.fallDetectionActive&&(n.startFallDetection(null),u(!0)),N.isActive()&&(y(!0),x())},x=async()=>{const s=N.getFormattedStatus();R(s)};i.useEffect(()=>{let s;return d&&(s=setInterval(x,5e3),x()),()=>{s&&clearInterval(s)}},[d]);const J=async()=>{try{t?await n.stopMonitoring():await n.startMonitoring(),a(!t),await n.saveEmergencyData(),setTimeout(()=>{p(n.getLocationStatus())},1e3)}catch(s){alert("âš ï¸ Error: "+s.message)}},O=async()=>{r.name&&r.phone&&(await n.addEmergencyContact(r),await H(),m({name:"",phone:"",relationship:"",primary:!1}),A(!1))},G=async()=>{f(!0),n.playEmergencyAlarm();let s=5;v(s);const l=setInterval(()=>{s--,v(s),s<=0&&(clearInterval(l),U())},1e3),q=()=>{clearInterval(l),v(null),f(!1),n.stopEmergencyAlarm()};window.emergencyCancelCountdown=q},U=async()=>{v(null),E(!0);try{await n.triggerManualEmergency(),f(!1),alert(`ğŸš¨ Emergency protocol activated!
â€¢ Calling 999
â€¢ Contacts notified
â€¢ Location shared`)}catch(s){f(!1),n.stopEmergencyAlarm(),alert("Failed to trigger emergency: "+s.message)}E(!1)},V=async()=>{k(!0);try{const s=await n.shareCurrentLocation();s.success&&p({tracking:o?.tracking||!1,currentLocation:s.location,lastUpdate:new Date})}catch(s){const l=s.message.includes("denied")?"Location permission denied. Please enable GPS in your device settings.":s.message.includes("timeout")?"GPS timeout. Make sure location services are enabled and try again.":"Failed to get location: "+s.message;alert(l)}k(!1)};return e.jsx("div",{className:"emergency-overlay",children:e.jsxs("div",{className:"emergency-modal",children:[e.jsx("button",{className:"emergency-close",onClick:S,children:"âœ•"}),e.jsx("h2",{className:"emergency-title",children:"ğŸš¨ Emergency Assistant"}),e.jsx("p",{className:"emergency-disclaimer",children:"âš ï¸ Requires manual activation. Not a medical device. Not a substitute for emergency services."}),e.jsxs("div",{className:`monitoring-status ${t?"active":"inactive"}`,children:[e.jsxs("div",{className:"status-indicator",children:[e.jsx("span",{className:"status-pulse"}),e.jsx("span",{className:"status-text",children:t?"âœ“ 24/7 Monitoring Active":"âš ï¸ Monitoring Disabled"})]}),e.jsx("button",{className:`toggle-monitoring ${t?"active":""}`,onClick:J,children:t?"Disable":"Enable"})]}),e.jsx("div",{className:"fall-detection-section",children:e.jsxs("div",{className:"fall-detection-header",children:[e.jsx("span",{className:"fall-icon",children:"ğŸ¤•"}),e.jsxs("div",{className:"fall-info",children:[e.jsx("h3",{children:"Fall Detection"}),e.jsx("p",{className:"fall-description",children:"Automatically detect hard falls using phone sensors"})]}),e.jsx("button",{className:`toggle-fall-detection ${j?"active":""}`,onClick:async()=>{if(j)await n.stopFallDetection(),u(!1);else{if(window.AndroidPermission){const s=window.AndroidPermission.isAndroid14Plus(),l=window.AndroidPermission.canUseFullScreenIntent();if(s&&!l&&!F){w(!0),$(!0);return}}await n.startFallDetection(null),u(!0)}await n.saveEmergencyData()},children:j?"Disable":"Enable"})]})}),e.jsxs("div",{className:"fall-detection-section",children:[e.jsxs("div",{className:"fall-detection-header",children:[e.jsx("span",{className:"fall-icon",children:"ğŸ©º"}),e.jsxs("div",{className:"fall-info",children:[e.jsx("h3",{children:"24/7 Health Monitoring"}),e.jsx("p",{className:"fall-description",children:"Monitor heart rate, movement, location for emergencies"})]}),e.jsx("button",{className:`toggle-fall-detection ${d?"active":""}`,onClick:async()=>{try{d?(await N.stop(),y(!1)):(await N.start(),y(!0),x())}catch(s){console.error("Health monitoring toggle error:",s),alert("âš ï¸ Error: "+s.message)}},children:d?"Disable":"Enable"})]}),d&&e.jsxs("div",{className:"health-status-display",children:[e.jsxs("div",{className:"health-metric",children:[e.jsx("span",{className:"metric-label",children:"ğŸ’“ Heart Rate:"}),e.jsx("span",{className:"metric-value",children:c.heartRate||"N/A"})]}),e.jsxs("div",{className:"health-metric",children:[e.jsx("span",{className:"metric-label",children:"ğŸƒ Last Movement:"}),e.jsx("span",{className:"metric-value",children:c.lastMovement||"N/A"})]}),e.jsxs("div",{className:"health-metric",children:[e.jsx("span",{className:"metric-label",children:"â±ï¸ Stillness:"}),e.jsx("span",{className:"metric-value",children:c.stillnessHours>0?`${c.stillnessHours}h ${c.stillnessMinutes%60}m`:`${c.stillnessMinutes||0}m`})]}),e.jsxs("div",{className:"health-metric",children:[e.jsx("span",{className:"metric-label",children:"ğŸ“ Location:"}),e.jsx("span",{className:"metric-value",children:c.locationAvailable?"âœ“ Tracking":"Not available"})]}),e.jsxs("div",{className:"health-features",children:[e.jsx("span",{className:"feature-badge",children:"âœ“ Heart Rate"}),e.jsx("span",{className:"feature-badge",children:"âœ“ Movement"}),e.jsx("span",{className:"feature-badge",children:"âœ“ Falls"}),e.jsx("span",{className:"feature-badge",children:"âœ“ Location"})]})]})]}),T&&e.jsx("div",{className:"permission-dialog-overlay",children:e.jsxs("div",{className:"permission-dialog",children:[e.jsx("h3",{children:"ğŸ”” Enable Full-Screen Alerts"}),e.jsx("p",{className:"permission-message",children:'To show emergency alerts over the lock screen when a fall is detected, please enable "Display over other apps" permission.'}),e.jsxs("div",{className:"permission-steps",children:[e.jsx("div",{className:"step",children:'1ï¸âƒ£ Tap "Open Settings" below'}),e.jsx("div",{className:"step",children:'2ï¸âƒ£ Enable "Display over lock screen"'}),e.jsx("div",{className:"step",children:'3ï¸âƒ£ Return here and tap "Enable" again'})]}),e.jsxs("div",{className:"permission-buttons",children:[e.jsx("button",{className:"permission-btn open-settings",onClick:()=>{window.AndroidPermission&&window.AndroidPermission.requestFullScreenIntentPermission(),w(!1)},children:"ğŸ“± Open Settings"}),e.jsx("button",{className:"permission-btn skip",onClick:async()=>{w(!1),await n.startFallDetection(null),u(!0),await n.saveEmergencyData()},children:"Skip (Notification Only)"})]})]})}),o&&e.jsxs("div",{className:`location-status ${o.tracking?"tracking":"inactive"}`,children:[e.jsxs("div",{className:"location-header",children:[e.jsx("span",{className:"location-icon",children:"ğŸ“"}),e.jsx("span",{className:"location-text",children:o.tracking?"GPS Tracking Active":"Location Ready - Tap to Share"})]}),o.currentLocation&&e.jsxs("div",{className:"location-details",children:[e.jsxs("div",{className:"location-coord",children:[e.jsx("strong",{children:"Location:"})," ",o.currentLocation.latitude.toFixed(6),", ",o.currentLocation.longitude.toFixed(6)]}),e.jsxs("div",{className:"location-accuracy",children:[e.jsx("strong",{children:"Accuracy:"})," Â±",Math.round(o.currentLocation.accuracy),"m"]}),o.lastUpdate&&e.jsxs("div",{className:"location-time",children:[e.jsx("strong",{children:"Last Update:"})," ",new Date(o.lastUpdate).toLocaleTimeString()]})]}),e.jsx("button",{className:"share-location-btn",onClick:V,disabled:C,children:C?"ğŸ“ Getting Location...":"ğŸ“ Share My Location"})]}),e.jsxs("div",{className:"emergency-trigger",children:[e.jsx("button",{className:"panic-button",onClick:G,disabled:M,children:L?`ğŸš¨ CALLING IN ${L}...`:M?"ğŸš¨ CALLING 999...":"ğŸ†˜ EMERGENCY - CALL 999"}),e.jsx("p",{className:"panic-help",children:"Press and hold to call 999 emergency services. Location will be shared with your contacts."})]}),t&&h&&e.jsxs("div",{className:"monitoring-info",children:[e.jsx("h3",{children:"ğŸ“Š Health Monitoring"}),e.jsxs("div",{className:"info-grid",children:[e.jsxs("div",{className:"info-item",children:[e.jsx("span",{className:"info-label",children:"Last Check:"}),e.jsx("span",{className:"info-value",children:new Date(h.lastCheck).toLocaleTimeString()})]}),e.jsxs("div",{className:"info-item",children:[e.jsx("span",{className:"info-label",children:"Check Interval:"}),e.jsx("span",{className:"info-value",children:"5 minutes"})]}),e.jsxs("div",{className:"info-item",children:[e.jsx("span",{className:"info-label",children:"Anomalies:"}),e.jsx("span",{className:"info-value",children:h.anomaliesDetected||0})]})]})]}),e.jsxs("div",{className:"emergency-contacts",children:[e.jsxs("div",{className:"contacts-header",children:[e.jsx("h3",{children:"ğŸ‘¥ Emergency Contacts"}),e.jsxs("button",{className:"add-contact-btn",onClick:()=>A(!g),children:[g?"âœ•":"+"," ",g?"Cancel":"Add"]})]}),g&&e.jsxs("div",{className:"add-contact-form",children:[e.jsx("input",{type:"text",placeholder:"Name",value:r.name,onChange:s=>m({...r,name:s.target.value}),className:"contact-input"}),e.jsx("input",{type:"tel",placeholder:"Phone",value:r.phone,onChange:s=>m({...r,phone:s.target.value}),className:"contact-input"}),e.jsx("input",{type:"text",placeholder:"Relationship",value:r.relationship,onChange:s=>m({...r,relationship:s.target.value}),className:"contact-input"}),e.jsxs("label",{className:"primary-checkbox",children:[e.jsx("input",{type:"checkbox",checked:r.primary,onChange:s=>m({...r,primary:s.target.checked})}),"Primary Contact"]}),e.jsx("button",{className:"save-contact-btn",onClick:O,children:"âœ“ Save Contact"})]}),e.jsx("div",{className:"contacts-list",children:b.length===0?e.jsxs("div",{className:"no-contacts",children:[e.jsx("p",{children:"âš ï¸ No emergency contacts added"}),e.jsx("p",{className:"help-text",children:"Add at least one contact for emergency alerts"})]}):b.map((s,l)=>e.jsxs("div",{className:`contact-card ${s.primary?"primary":""}`,children:[e.jsx("div",{className:"contact-icon",children:s.primary?"â­":"ğŸ‘¤"}),e.jsxs("div",{className:"contact-info",children:[e.jsx("div",{className:"contact-name",children:s.name}),e.jsx("div",{className:"contact-phone",children:s.phone}),e.jsx("div",{className:"contact-relationship",children:s.relationship})]}),s.primary&&e.jsx("div",{className:"primary-badge",children:"Primary"})]},l))})]}),e.jsxs("div",{className:"emergency-features",children:[e.jsxs("div",{className:"feature-item",children:[e.jsx("span",{className:"feature-icon",children:"ğŸ”"}),e.jsx("span",{className:"feature-text",children:"Detects unusual health patterns"})]}),e.jsxs("div",{className:"feature-item",children:[e.jsx("span",{className:"feature-icon",children:"ğŸ“±"}),e.jsx("span",{className:"feature-text",children:"Auto-alerts emergency contacts"})]}),e.jsxs("div",{className:"feature-item",children:[e.jsx("span",{className:"feature-icon",children:"ğŸš‘"}),e.jsx("span",{className:"feature-text",children:"Sends medical data to ambulance"})]}),e.jsxs("div",{className:"feature-item",children:[e.jsx("span",{className:"feature-icon",children:"ğŸ“"}),e.jsx("span",{className:"feature-text",children:"Shares your location instantly"})]})]})]})})}export{K as default};
