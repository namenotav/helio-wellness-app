const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/chunk-1765888035986-battleNotificationsService.js","assets/entry-1765888035645-index.js","assets/asset-1765888036385-index.css"])))=>i.map(i=>d[i]);
import{f as u,a as n,_ as c}from"./entry-1765888035645-index.js";import{healthAvatarService as d}from"./chunk-1765888035648-healthAvatarService.js";class h{constructor(){this.activeBattles=[],this.completedBattles=[],this.userStats={wins:0,losses:0,winRate:0,totalBattles:0},this.initialized=!1,this.init()}async init(){if(!this.initialized)try{const t=localStorage.getItem("battles_data");if(t){const a=JSON.parse(t);this.activeBattles=a.activeBattles||[],this.completedBattles=a.completedBattles||[],this.userStats=a.userStats||{wins:0,losses:0,winRate:0,totalBattles:0}}const e=await u.get("battles_data",n.getCurrentUser()?.uid);if(e){const a=new Map;this.activeBattles.forEach(s=>a.set(s.id,s)),(e.activeBattles||[]).forEach(s=>a.set(s.id,s)),this.activeBattles=Array.from(a.values());const r=new Map;this.completedBattles.forEach(s=>r.set(s.id,s)),(e.completedBattles||[]).forEach(s=>r.set(s.id,s)),this.completedBattles=Array.from(r.values()),e.userStats&&(this.userStats=e.userStats),await this.saveData()}this.initialized=!0}catch{this.initialized=!0}}async saveData(){try{const t={activeBattles:this.activeBattles,completedBattles:this.completedBattles,userStats:this.userStats,lastUpdated:new Date().toISOString()};localStorage.setItem("battles_data",JSON.stringify(t)),await u.save("battles_data",t,n.getCurrentUser()?.uid)}catch{}}async createBattle(t){const e=n.getCurrentUser();if(!e)return{success:!1,error:"Not logged in"};const a="BTL-"+Date.now(),r=this.generateShareCode(a),s={id:a,creator:{id:e.id,name:e.name||e.email?.split("@")[0]||"Anonymous",avatar:e.profile?.avatar||"ðŸ‘¤"},participants:[e.id],config:{duration:t.duration||30,goal:t.goal||"steps",target:t.target||1e4,stakes:t.stakes||"bragging-rights",stakeAmount:t.stakeAmount||0},startDate:null,endDate:null,status:"pending",leaderboard:[],shareCode:r,created:new Date().toISOString()};this.activeBattles.push(s),await this.saveData();try{const{default:i}=await c(async()=>{const{default:o}=await import("./chunk-1765888035986-battleNotificationsService.js");return{default:o}},__vite__mapDeps([0,1,2]));await i.sendBattleInvite({creatorName:e.name||"A friend",goal:s.config.goal,battleId:s.id})}catch{}return{success:!0,battleId:s.id,shareCode:s.shareCode,battle:s}}async joinBattle(t){const e=n.getCurrentUser();if(!e)return{success:!1,error:"Not logged in"};const a=this.activeBattles.find(r=>r.id===t);if(!a)return{success:!1,error:"Battle not found"};if(a.participants.includes(e.id))return{success:!1,error:"Already joined"};if(a.participants.push(e.id),a.participants.length>=2&&a.status==="pending"){a.status="active",a.startDate=new Date().toISOString(),a.endDate=new Date(Date.now()+a.config.duration*24*60*60*1e3).toISOString(),await this.initializeLeaderboard(a);try{const{default:r}=await c(async()=>{const{default:s}=await import("./chunk-1765888035986-battleNotificationsService.js");return{default:s}},__vite__mapDeps([0,1,2]));await r.scheduleBattleEndingReminder({battleId:a.id,name:`${a.config.goal} Battle`,endDate:a.endDate})}catch{}}return await this.saveData(),{success:!0,battle:a,message:"Joined battle successfully!"}}async initializeLeaderboard(t){const e=[];for(const a of t.participants){const r=await d.getAvatarState(),s=this.getRelevantScore(t.config.goal,r);e.push({userId:a,userName:"User",startScore:s,currentScore:s,progress:0,rank:0})}t.leaderboard=e,this.updateRankings(t)}getRelevantScore(t,e){switch(t){case"health-score":return e?.current?.score||0;case"steps":return 0;case"weight-loss":return 0;default:return 0}}async updateProgress(t){const e=this.activeBattles.find(i=>i.id===t);if(!e||e.status!=="active")return;const a=n.getCurrentUser(),r=e.leaderboard.find(i=>i.userId===a.id);if(!r)return;const s=await d.getAvatarState();return r.currentScore=this.getRelevantScore(e.config.goal,s),r.progress=r.currentScore-r.startScore,this.updateRankings(e),new Date>=new Date(e.endDate)&&await this.completeBattle(e),await this.saveData(),{success:!0,leaderboard:e.leaderboard}}updateRankings(t){t.leaderboard.sort((e,a)=>(t.config.goal==="weight-loss",a.progress-e.progress)),t.leaderboard.forEach((e,a)=>{e.rank=a+1})}async completeBattle(t){t.status="completed";const e=t.leaderboard[0],a=t.leaderboard[t.leaderboard.length-1];t.results={winner:{userId:e.userId,userName:e.userName,finalScore:e.currentScore,improvement:e.progress},loser:{userId:a.userId,userName:a.userName,finalScore:a.currentScore,improvement:a.progress},completedAt:new Date().toISOString()},t.config.stakes==="subscription"?t.results.paymentDue={from:a.userId,to:e.userId,amount:t.config.stakeAmount,description:"Premium subscription payment"}:t.config.stakes==="money"&&(t.results.paymentDue={from:a.userId,to:e.userId,amount:t.config.stakeAmount,description:"Battle winnings"}),this.completedBattles.push(t),this.activeBattles=this.activeBattles.filter(s=>s.id!==t.id);const r=n.getCurrentUser();if(r){const s=e.userId===r.id,i=a.userId===r.id;s?this.userStats.wins++:i&&this.userStats.losses++,this.userStats.totalBattles++,this.userStats.winRate=this.userStats.totalBattles>0?Math.round(this.userStats.wins/this.userStats.totalBattles*100):0;try{const{default:o}=await c(async()=>{const{default:g}=await import("./chunk-1765888035986-battleNotificationsService.js");return{default:g}},__vite__mapDeps([0,1,2])),l=s?100:25;s?await o.sendBattleVictory({name:`${t.config.goal} Battle`,xp:l,battleId:t.id}):i&&await o.sendBattleDefeat({name:`${t.config.goal} Battle`,xp:l,battleId:t.id})}catch{}}return await this.saveData(),t.results}getLiveLeaderboard(t){const e=this.activeBattles.find(a=>a.id===t);return e?{battleId:e.id,status:e.status,daysRemaining:this.calculateDaysRemaining(e.endDate),leaderboard:e.leaderboard,stakes:e.config.stakes,stakeAmount:e.config.stakeAmount}:null}calculateDaysRemaining(t){if(!t)return null;const e=Math.ceil((new Date(t)-new Date)/(1e3*60*60*24));return Math.max(0,e)}generateShareCode(t){return btoa(t).substring(0,8).toUpperCase()}async joinByShareCode(t){const e=atob(t.toLowerCase());return this.joinBattle(e)}getActiveBattles(){const t=n.getCurrentUser();return t?this.activeBattles.filter(e=>e.participants.includes(t.id)):[]}getBattleHistory(){const t=n.getCurrentUser();return t?this.completedBattles.filter(e=>e.participants.includes(t.id)):[]}async getRealTimeSteps(){try{const{Pedometer:t}=await c(async()=>{const{Pedometer:a}=await import("./entry-1765888035645-index.js").then(r=>r.z);return{Pedometer:a}},__vite__mapDeps([1,2]));return(await t.getStepCount()).steps||0}catch{const e=new Date().getHours();return Math.floor(Math.random()*1e3)+e*500}}async syncBattleProgress(t){const e=this.activeBattles.find(i=>i.id===t);if(!e||e.status!=="active")return;const a=n.getCurrentUser(),r=e.leaderboard.find(i=>i.userId===a.id);if(!r)return;const s=await this.getRealTimeSteps();return r.currentScore=s,r.progress=s-r.startScore,r.lastUpdate=new Date().toISOString(),this.updateRankings(e),{success:!0,currentSteps:s,progress:r.progress,rank:r.rank}}async autoSyncAllBattles(){const t=this.getActiveBattles();for(const e of t)await this.syncBattleProgress(e.id);return{success:!0,synced:t.length}}getBattleStats(){return n.getCurrentUser()?{totalBattles:this.userStats.totalBattles,wins:this.userStats.wins,losses:this.userStats.losses,winRate:this.userStats.winRate,activeBattles:this.getActiveBattles().length}:null}}const m=new h;export{m as default,m as socialBattlesService};
