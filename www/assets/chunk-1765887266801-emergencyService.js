const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/chunk-1765887266801-nativeFallDetectionService.js","assets/entry-1765887266798-index.js","assets/asset-1765887267361-index.css","assets/chunk-1765887266800-backgroundRunnerService.js"])))=>i.map(i=>d[i]);
import{G as l,a as o,H as w,I as v,L as d,C as n,S as f,_ as g,p as A,P as y}from"./entry-1765887266798-index.js";const h=async()=>{try{(await l.checkPermissions()).location!=="granted"&&await l.requestPermissions();const t=await l.getCurrentPosition({enableHighAccuracy:!0,timeout:1e4,maximumAge:0});return{latitude:t.coords.latitude,longitude:t.coords.longitude,accuracy:t.coords.accuracy,altitude:t.coords.altitude,speed:t.coords.speed,heading:t.coords.heading,timestamp:t.timestamp}}catch(c){throw c}};let u=null;const D=async c=>{try{return u=await l.watchPosition({enableHighAccuracy:!0,timeout:5e3,maximumAge:0},(t,e)=>{e||c({latitude:t.coords.latitude,longitude:t.coords.longitude,accuracy:t.coords.accuracy,altitude:t.coords.altitude,speed:t.coords.speed,timestamp:t.timestamp})}),u}catch(t){throw t}},S=async()=>{u!==null&&(await l.clearWatch({id:u}),u=null)};class C{constructor(){this.monitoring=!1,this.emergencyContacts=[],this.healthBaseline=null,this.currentLocation=null,this.gpsWatchId=null,this.locationHistory=[],this.fallDetectionActive=!1,this.alarmAudio=null,this.fallDetectionCallback=null,this.globalFallAlertCallback=null,this.initializeFallDetection()}async initializeFallDetection(){try{(await this.loadEmergencyData())?.fallDetection&&!this.fallDetectionActive&&setTimeout(()=>{this.globalFallAlertCallback&&this.startFallDetection(this.globalFallAlertCallback)},1e3)}catch{}}setGlobalFallAlertCallback(t){this.globalFallAlertCallback=t,this.fallDetectionActive&&!this.fallMotionSubscription&&this.startFallDetection(t)}async startMonitoring(){const t=o.getCurrentUser();t&&(await this.loadEmergencyData(),this.healthBaseline=this.establishBaseline(t)),this.monitoring=!0;try{this.currentLocation=await h(),this.gpsWatchId=await D(e=>{this.currentLocation=e,this.locationHistory.push({...e,timestamp:Date.now()}),this.locationHistory.length>100&&this.locationHistory.shift()})}catch{alert("âš ï¸ Unable to access GPS. Emergency location sharing may be limited.")}this.monitoringInterval=setInterval(()=>{this.checkForEmergencies()},300*1e3)}async stopMonitoring(){this.monitoring=!1,this.monitoringInterval&&clearInterval(this.monitoringInterval),this.gpsWatchId&&(await S(),this.gpsWatchId=null)}establishBaseline(t){const e=t?.stats||{};t?.profile;const a=e.totalDays||0,i=e.totalSteps||0;return{avgDailySteps:a>0?i/a:5e3,normalActivityPattern:this.calculateActivityPattern(e),typicalHeartRate:70,normalSleepHours:7}}calculateActivityPattern(t){return{morningActivity:.3,afternoonActivity:.5,eveningActivity:.2}}async checkForEmergencies(){const t=o.getCurrentUser();if(!t)return;const e=this.getCurrentMetrics(t),a=this.detectAnomalies(e);a.length>0&&await this.handleEmergency(a)}getCurrentMetrics(t){const e=new Date().toDateString();return{stepsToday:t.stats.dailySteps?.[e]||0,lastActiveTime:t.profile.lastActive||new Date,recentFoodLog:t.profile.foodLog?.slice(-5)||[],recentSymptoms:t.profile.symptomLog?.slice(-3)||[]}}detectAnomalies(t){const e=[];(new Date-new Date(t.lastActiveTime))/36e5>24&&e.push({type:"inactivity",severity:"high",message:"No activity detected for 24+ hours",action:"check-welfare"});const i=t.recentFoodLog.filter(s=>s.safety==="danger"),r=t.recentSymptoms.filter(s=>s.severity==="severe");return i.length>0&&r.length>0&&e.push({type:"allergic-reaction",severity:"critical",message:"Possible severe allergic reaction",action:"call-ambulance"}),this.healthBaseline&&t.stepsToday<this.healthBaseline.avgDailySteps*.2&&new Date().getHours()>12&&e.push({type:"unusual-inactivity",severity:"medium",message:"Unusual lack of movement detected",action:"send-alert"}),e}async handleEmergency(t){const e=t.find(a=>a.severity==="critical");e?await this.triggerEmergencyProtocol(e):await this.sendWarningNotification(t)}async triggerEmergencyProtocol(t){await this.emergencyHapticPattern(),await this.sendEmergencyNotification(t),await this.alertEmergencyContacts(t);const e=await this.prepareMedicalData();t.action==="call-ambulance"&&await this.simulateEmergencyCall(e)}async emergencyHapticPattern(){for(let t=0;t<5;t++)await w.impact({style:v.Heavy}),await new Promise(e=>setTimeout(e,200))}async sendEmergencyNotification(t){try{await d.schedule({notifications:[{title:"ðŸš¨ EMERGENCY ALERT",body:t.message+" - Emergency contacts notified",id:Date.now(),schedule:{at:new Date(Date.now()+1e3)},sound:"default",attachments:null,actionTypeId:"emergency",extra:{anomaly:t}}]})}catch{}}async alertEmergencyContacts(t){const a=o.getCurrentUser()?.profile?.emergencyContacts||[];for(const i of a);return{success:!0,contactsAlerted:a.length,timestamp:new Date().toISOString()}}async prepareMedicalData(){const t=o.getCurrentUser();if(!t)return null;let e=this.currentLocation;if(!e)try{e=await h()}catch{e={latitude:0,longitude:0,accuracy:-1}}return{patientInfo:{name:t.name,age:t.profile.age,bloodType:t.profile.bloodType||"Unknown",weight:t.profile.weight,height:t.profile.height},allergens:t.profile.allergens||[],medications:t.profile.medications||[],medicalConditions:t.profile.medicalConditions||[],emergencyContacts:t.profile.emergencyContacts||[],recentFoodLog:t.profile.foodLog?.slice(-10)||[],recentSymptoms:t.profile.symptomLog?.slice(-5)||[],timestamp:new Date().toISOString(),location:{latitude:e.latitude,longitude:e.longitude,accuracy:e.accuracy,altitude:e.altitude,googleMapsUrl:`https://www.google.com/maps?q=${e.latitude},${e.longitude}`,address:await this.reverseGeocode(e.latitude,e.longitude)},locationHistory:this.locationHistory.slice(-10)}}async simulateEmergencyCall(t){const e={success:!0,callPlaced:!1,contactsAlerted:0,locationShared:!1,medicalDataShared:!0,timestamp:new Date().toISOString()};try{(n.getPlatform()==="android"||n.getPlatform()==="ios")&&(window.open("tel:999","_system"),e.callPlaced=!0)}catch{}await this.shareLocationWithContacts(t),e.locationShared=!0,e.contactsAlerted=t.emergencyContacts.length;const a={id:Date.now(),type:"emergency_call",medicalData:t,timestamp:new Date().toISOString(),location:t.location},i=JSON.parse(localStorage.getItem("emergencyHistory")||"[]");return i.push(a),localStorage.setItem("emergencyHistory",JSON.stringify(i)),e}async shareLocationWithContacts(t){const{location:e,patientInfo:a,emergencyContacts:i}=t;if(!e||!e.latitude)return;const r=`ðŸš¨ EMERGENCY ALERT from ${a.name}

Location: ${e.googleMapsUrl}
Coordinates: ${e.latitude.toFixed(6)}, ${e.longitude.toFixed(6)}
Accuracy: Â±${Math.round(e.accuracy)}m
Time: ${new Date().toLocaleString("en-GB")}

Medical Info:
Blood Type: ${a.bloodType}
Age: ${a.age}
Allergens: ${t.allergens.join(", ")||"None"}

This is an automated emergency alert from WellnessAI app.`;try{await f.share({title:"ðŸš¨ Emergency Location Share",text:r,url:e.googleMapsUrl,dialogTitle:"Share Emergency Location"})}catch{}}async reverseGeocode(t,e){try{const i=await(await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${t}&lon=${e}&zoom=18&addressdetails=1`,{headers:{"User-Agent":"WellnessAI-EmergencyApp/1.0"}})).json();return i.display_name?i.display_name:`${t.toFixed(6)}, ${e.toFixed(6)}`}catch{return`${t.toFixed(6)}, ${e.toFixed(6)}`}}async sendWarningNotification(t){const e=t.map(a=>a.message).join(". ");try{await d.schedule({notifications:[{title:"âš ï¸ Health Warning",body:e,id:Date.now(),schedule:{at:new Date(Date.now()+1e3)},sound:"default"}]})}catch{}}async addEmergencyContact(t){const e=o.getCurrentUser();if(!e)return{success:!1};const a=e.profile.emergencyContacts||[];return a.push({name:t.name,phone:t.phone,relationship:t.relationship,primary:a.length===0}),await o.updateProfile({emergencyContacts:a}),this.emergencyContacts=a,await this.saveEmergencyData(),{success:!0}}async triggerManualEmergency(){const t={type:"manual-trigger",severity:"critical",message:"User manually triggered emergency alert",action:"call-ambulance"};await this.triggerEmergencyProtocol(t)}async shareCurrentLocation(){try{const t=await h(),e=o.getCurrentUser(),a=`ðŸ“ Live location from ${e?.profile?.fullName||e?.name||"WellnessAI user"}

Google Maps: https://www.google.com/maps?q=${t.latitude},${t.longitude}
Coordinates: ${t.latitude.toFixed(6)}, ${t.longitude.toFixed(6)}
Accuracy: Â±${Math.round(t.accuracy)}m
Time: ${new Date().toLocaleString("en-GB")}`;return await f.share({title:"ðŸ“ My Current Location",text:a,url:`https://www.google.com/maps?q=${t.latitude},${t.longitude}`,dialogTitle:"Share My Location"}),{success:!0,location:t}}catch(t){throw t}}getLocationStatus(){return{tracking:this.gpsWatchId!==null,currentLocation:this.currentLocation,locationHistoryCount:this.locationHistory.length,lastUpdate:this.currentLocation?new Date(this.currentLocation.timestamp):null}}async startFallDetection(t){try{if(n.isNativePlatform()&&n.getPlatform()==="android")try{const a=(await g(async()=>{const{default:i}=await import("./chunk-1765887266801-nativeFallDetectionService.js");return{default:i}},__vite__mapDeps([0,1,2]))).default;if(window.AndroidFallDetection)return await a.start(),a.addListener(i=>{this.handleFallDetected(t)}),this.fallDetectionActive=!0,this.fallDetectionCallback=t,await this.saveEmergencyData(),{success:!0,native:!0}}catch{}return await(await g(async()=>{const{default:a}=await import("./chunk-1765887266800-backgroundRunnerService.js");return{default:a}},__vite__mapDeps([3,1,2]))).default.start(),this.fallDetectionActive=!0,this.fallDetectionCallback=t,await this.saveEmergencyData(),this.fallMotionSubscription=await A.subscribe(a=>{if(!this.fallDetectionActive)return;const i=a.accelerationIncludingGravity||a.acceleration;if(!i)return;const{x:r,y:s,z:m}=i,p=Math.sqrt(r*r+s*s+m*m);(!this.lastAccelLog||Date.now()-this.lastAccelLog>2e3)&&(this.lastAccelLog=Date.now()),p>25&&this.handleFallDetected(this.fallDetectionCallback)},"FallDetection"),{success:!0}}catch(e){return alert("âš ï¸ Fall detection requires motion sensor access"),{success:!1,error:e}}}async stopFallDetection(){try{if(n.isNativePlatform()&&window.AndroidFallDetection)try{await(await g(async()=>{const{default:e}=await import("./chunk-1765887266801-nativeFallDetectionService.js");return{default:e}},__vite__mapDeps([0,1,2]))).default.stop()}catch{}this.fallMotionSubscription&&(this.fallMotionSubscription.unsubscribe(),this.fallMotionSubscription=null),this.fallDetectionActive=!1,await this.saveEmergencyData()}catch{}}async handleFallDetected(t){if(this.fallAlertActive)return;this.fallAlertActive=!0,this.playEmergencyAlarm(),await this.emergencyHapticPattern();const e=this.globalFallAlertCallback||t;e&&e({type:"fall",timestamp:new Date().toISOString(),location:this.currentLocation}),setTimeout(()=>{this.fallAlertActive=!1},1e4)}async callPrimaryContact(){const t=this.emergencyContacts.find(e=>e.primary);if(!t){alert("âš ï¸ No primary emergency contact set. Please add one in settings.");return}try{n.getPlatform()==="android"||n.getPlatform()==="ios"?window.open(`tel:${t.phone}`,"_system"):alert(`ðŸ“ž Calling ${t.name} at ${t.phone}`)}catch(e){alert("Failed to place call: "+e.message)}}async call999(){try{n.getPlatform()==="android"||n.getPlatform()==="ios"?window.open("tel:999","_system"):alert("ðŸ“ž Calling 999")}catch(t){alert("Failed to place emergency call: "+t.message)}}playEmergencyAlarm(){try{const t=new(window.AudioContext||window.webkitAudioContext),e=t.createOscillator(),a=t.createGain();e.connect(a),a.connect(t.destination),e.frequency.value=800;let i=!0;const r=setInterval(()=>{e.frequency.value=i?800:1e3,i=!i},500);e.type="sine",a.gain.value=.3,e.start(),this.alarmAudio={oscillator:e,gainNode:a,interval:r,context:t}}catch{}}stopEmergencyAlarm(){if(this.alarmAudio)try{clearInterval(this.alarmAudio.interval),this.alarmAudio.oscillator.stop(),this.alarmAudio.context.close(),this.alarmAudio=null}catch{}}async saveEmergencyData(){try{const t={contacts:this.emergencyContacts,monitoring:this.monitoring,fallDetection:this.fallDetectionActive,lastUpdate:new Date().toISOString()};await y.set({key:"emergency_data",value:JSON.stringify(t)})}catch{}}async loadEmergencyData(){try{const{value:t}=await y.get({key:"emergency_data"});if(t){const a=JSON.parse(t);return this.emergencyContacts=a.contacts||[],this.monitoring=a.monitoring||!1,this.fallDetectionActive=a.fallDetection||!1,a}const e=o.getCurrentUser();return e?.profile?.emergencyContacts&&(this.emergencyContacts=e.profile.emergencyContacts,await this.saveEmergencyData()),null}catch{return null}}}const b=new C;export{b as default,b as emergencyService};
